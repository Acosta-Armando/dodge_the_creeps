# Siempre que se haga un push de etiqueta que coincida con el patr√≥n "v*" se ejecuta el job
on:
  push:
    tags:
      - "v*"
jobs:
  export_game:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    name: Export Game (Windows & Android)
    steps:
      # 1. Checkout del c√≥digo
      - name: checkout
        uses: actions/checkout@v5
    
      # --- Configuraci√≥n Espec√≠fica de Android ---
      
      # 2. Configurar Java (necesario para la herramienta de Android)
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Configurar Android SDK (necesario para la exportaci√≥n de Godot a Android)
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: 'build-tools;34.0.0 platform-tools'

      # 4. Descargar y preparar los ejecutables de Godot y las plantillas
      - name: Setup Godot for Template Installation
        uses: firebelley/godot-export@v7.0.0
        with:
          godot_executable_download_url: https://master.dl.sourceforge.net/project/godot-engine.mirror/4.5-stable/Godot_v4.5-stable_linux.x86_64.zip
          godot_export_templates_download_url: https://master.dl.sourceforge.net/project/godot-engine.mirror/4.5-stable/Godot_v4.5-stable_export_templates.tpz
          relative_project_path: ./
          # Solo descarga, no exporta todav√≠a
          
      # üöÄ ‚úÖ NUEVO PASO: Instalar el template de construcci√≥n de Android
      - name: Install Android Build Template
        run: |
          # El paso anterior descarg√≥ las plantillas. Ahora las copiamos al proyecto.
          TEMPLATES_DIR=$(echo "$HOME/.local/share/godot/export_templates"/* | head -n 1)
          ANDROID_TEMPLATE_PATH="$TEMPLATES_DIR/android_source.zip"
        
          echo "Copiando template de $ANDROID_TEMPLATE_PATH"
          mkdir -p android/build
          unzip -q "$ANDROID_TEMPLATE_PATH" -d android/build
          echo "Contenido de android/build:"
          ls -R android/build

      # --- Exportaci√≥n de Godot ---
      
      # 5. Exportar el juego para ambas plataformas
      - name: export game (Windows & Android)
        id: export
        uses: firebelley/godot-export@v7.0.0
        with:
          godot_executable_download_url: https://master.dl.sourceforge.net/project/godot-engine.mirror/4.5-stable/Godot_v4.5-stable_linux.x86_64.zip
          godot_export_templates_download_url: https://master.dl.sourceforge.net/project/godot-engine.mirror/4.5-stable/Godot_v4.5-stable_export_templates.tpz
          relative_project_path: ./
          archive_output: true
          android_keystore_base64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          android_keystore_alias: ${{ secrets.ANDROID_KEYSTORE_ALIAS }}
          android_keystore_password: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}

      # --- Creaci√≥n del Release ---
      
      # 5. Crear el release con los artefactos de ambas exportaciones
      - name: create release
        uses: ncipollo/release-action@v1.18.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          generateReleaseNotes: true
          tag: ${{ github.ref_name }}
          # Adjunta todos los archivos creados en el directorio de salida del paso 'export'
          artifacts: ${{ steps.export.outputs.archive_directory }}/*